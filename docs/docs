# Resumen de Correcciones del Backend

## üìã Archivos Modificados

### 1. Modelos Corregidos

#### `app/server/src/models/CategoriaGasto.ts`
- ‚úÖ **Correcci√≥n:** `tableName` cambiado de `'categoria_gasto'` a `'categoriagasto'` (sin gui√≥n bajo)
- ‚úÖ **Correcci√≥n:** `nombre` cambiado de VARCHAR(150) a VARCHAR(100)
- ‚úÖ **Correcci√≥n:** `descripcion` cambiado de VARCHAR(400) a VARCHAR(300)

#### `app/server/src/models/Usuario.ts`
- ‚úÖ **Correcci√≥n:** `email` cambiado de VARCHAR(150) a VARCHAR(100)
- ‚úÖ **Correcci√≥n:** `telefono` cambiado de VARCHAR(30) a VARCHAR(20)

#### `app/server/src/models/CajaRegistradora.ts`
- ‚úÖ **Correcci√≥n:** `numeroCaja` cambiado de VARCHAR(50) a VARCHAR(20)
- ‚úÖ **Correcci√≥n:** `montoInicialRequerido` cambiado de DECIMAL(14,2) a DECIMAL(10,2) con default 75.00
- ‚úÖ **Correcci√≥n:** `ubicacion` cambiado de VARCHAR(150) a VARCHAR(100)

#### `app/server/src/models/CajaFuerte.ts`
- ‚úÖ **Correcci√≥n:** Eliminado campo `ubicacion` (no existe en DDL)
- ‚úÖ **Correcci√≥n:** `saldoActual` cambiado de DECIMAL(18,2) a DECIMAL(12,2)
- ‚úÖ **Correcci√≥n:** `limiteMaximo` cambiado de DECIMAL(18,2) a DECIMAL(12,2)

#### `app/server/src/models/Gasto.ts`
- ‚úÖ **Correcci√≥n:** `numeroComprobante` cambiado a nullable y VARCHAR(50) (antes VARCHAR(200) NOT NULL)
- ‚úÖ **Correcci√≥n:** `rutaComprobante` cambiado a nullable y VARCHAR(300) (antes VARCHAR(400) NOT NULL)

#### `app/server/src/models/ReporteDiario.ts`
- ‚úÖ **Correcci√≥n:** Eliminados campos `resumenDiferencias` y `cantidadDiferencias` (no existen en DDL)

### 2. Rutas Creadas/Modificadas

#### `app/server/src/routes/auth.ts` (NUEVO)
- ‚úÖ **Creado:** Ruta `POST /auth/login`
  - Valida email y contrase√±a
  - Compara contrase√±a con bcrypt
  - Verifica `estadoActivo = 1`
  - Hace JOIN con tabla `rol`
  - Retorna token JWT + datos del usuario + nombre del rol

#### `app/server/src/routes/usuarios.ts`
- ‚úÖ **Modificado:** `POST /usuario`
  - Ahora acepta `contrasena` (no `contrasenaHash`)
  - Hashea la contrase√±a con bcrypt antes de guardar
  - Convierte `estadoActivo` boolean ‚Üí numeric(1/0)
  - No retorna `contrasenaHash` en la respuesta

- ‚úÖ **Modificado:** `GET /usuario`
  - Ahora hace JOIN con tabla `rol`
  - Retorna solo campos: `idUsuario`, `nombreCompleto`, `email`, `estadoActivo`, `nombreRol`

- ‚úÖ **Creado:** `PATCH /usuario/:id/estado`
  - Actualiza solo el campo `estadoActivo`
  - Acepta boolean o number (1/0)
  - Convierte correctamente a numeric

- ‚úÖ **Modificado:** `PUT /usuario/:idUsuario`
  - Si se actualiza `contrasena`, la hashea con bcrypt
  - No retorna `contrasenaHash` en la respuesta

### 3. Schemas Creados/Modificados

#### `app/server/src/schemas/auth.ts` (NUEVO)
- ‚úÖ **Creado:** Schema de validaci√≥n para login
  - `email`: string con validaci√≥n de email
  - `contrasena`: string requerido

#### `app/server/src/schemas/usuario.ts`
- ‚úÖ **Modificado:** `usuarioCreateSchema`
  - Cambiado `contrasenaHash` por `contrasena`
  - `estadoActivo` acepta boolean o number
  - `telefono` ahora es opcional sin m√≠nimo de caracteres

- ‚úÖ **Creado:** `usuarioEstadoSchema`
  - Para validar el body de `PATCH /usuario/:id/estado`

### 4. Configuraci√≥n

#### `app/server/src/index.ts`
- ‚úÖ **Modificado:** Agregadas rutas sin prefijo `/api`
  - `/auth` ‚Üí rutas de autenticaci√≥n
  - `/usuario` ‚Üí rutas de usuario
  - Mantiene compatibilidad con `/api/usuarios`

#### `app/server/package.json`
- ‚úÖ **Agregado:** `@types/bcrypt` y `@types/jsonwebtoken` en devDependencies
- ‚úÖ **Verificado:** `bcrypt` y `jsonwebtoken` ya estaban instalados

## ‚úÖ Validaciones Realizadas

### Tablas Verificadas (Todas en singular)
- ‚úÖ `usuario` (correcto)
- ‚úÖ `rol` (correcto)
- ‚úÖ `caja_fuerte` (correcto)
- ‚úÖ `caja_registradora` (correcto)
- ‚úÖ `estado_gasto` (correcto)
- ‚úÖ `tipo_conteo` (correcto)
- ‚úÖ `tipo_diferencia` (correcto)
- ‚úÖ `venta_diaria` (correcto)
- ‚úÖ `bitacora_auditoria` (correcto)
- ‚úÖ `categoriagasto` (corregido: era `categoria_gasto`)
- ‚úÖ `conteo` (correcto)
- ‚úÖ `diferencia_caja` (correcto)
- ‚úÖ `gasto` (correcto)
- ‚úÖ `reporte_diario` (correcto)
- ‚úÖ `store` (correcto)

## üß™ Endpoints Listos para Probar

### 1. Login
```bash
curl -X POST http://localhost:3000/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"dm@company.com","contrasena":"dm-123"}'
```

### 2. Crear Usuario
```bash
curl -X POST http://localhost:3000/usuario \
  -H "Content-Type: application/json" \
  -d '{"nombreCompleto":"Test","email":"test@mail.com","contrasena":"123","telefono":"111","idRol":1}'
```

### 3. Cambiar Estado
```bash
curl -X PATCH http://localhost:3000/usuario/1/estado \
  -H "Content-Type: application/json" \
  -d '{"estadoActivo":0}'
```

### 4. Listar Usuarios
```bash
curl http://localhost:3000/usuario
```

## üìù Notas Importantes

1. **Tablas en Singular:** Todas las tablas est√°n en singular seg√∫n el DDL real
2. **Bcrypt:** Las contrase√±as se hashean autom√°ticamente al crear/actualizar usuarios
3. **Estado Activo:** Se maneja como numeric(1/0) en la BD pero como boolean en el c√≥digo
4. **Compatibilidad:** Se mantienen rutas `/api/*` para compatibilidad con c√≥digo existente
5. **Campos Eliminados:** Se eliminaron campos que no existen en el DDL real:
   - `ReporteDiario.resumenDiferencias`
   - `ReporteDiario.cantidadDiferencias`
   - `CajaFuerte.ubicacion`

## üîÑ Pr√≥ximos Pasos

1. Ejecutar `npm install` en `app/server` para instalar los tipos de TypeScript
2. Probar los endpoints con los comandos curl proporcionados
3. Verificar que el frontend pueda consumir las nuevas rutas
4. Revisar otros m√≥dulos (gastos, ventas, etc.) para asegurar consistencia


